// Настоящий AI ассистент с Google Gemini API
export async function getAIResponse({ lifecycleStage, query }: { lifecycleStage: string; query: string }) {
  try {
    // Получаем API ключ из переменных окружения или используем демо ключ
    const apiKey = import.meta.env.VITE_GOOGLE_AI_API_KEY || 'demo-key';
    
    if (apiKey === 'demo-key') {
      // Fallback на умные ответы если нет API ключа
      return getSmartFallbackResponse(lifecycleStage, query);
    }

    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash-exp:generateContent?key=${apiKey}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        contents: [{
          parts: [{
            text: `Ты - персональный AI ассистент по здоровью для матерей. Предоставляй советы, рекомендации и дыхательные упражнения на основе выбранного этапа жизни пользователя.

Этап жизни пользователя: ${lifecycleStage}
Вопрос пользователя: ${query}

Отвечай на русском языке, будь дружелюбным и поддерживающим. Давай практические советы, но всегда напоминай обратиться к врачу при серьезных проблемах.`
          }]
        }],
        generationConfig: {
          temperature: 0.7,
          topK: 40,
          topP: 0.95,
          maxOutputTokens: 1024,
        }
      })
    });

    if (!response.ok) {
      throw new Error(`API Error: ${response.status}`);
    }

    const data = await response.json();
    const aiResponse = data.candidates?.[0]?.content?.parts?.[0]?.text || 'Извините, не удалось получить ответ от AI.';

    return {
      success: true,
      response: aiResponse
    };

  } catch (error) {
    console.error('AI Assistant Error:', error);
    // Fallback на умные ответы при ошибке
    return getSmartFallbackResponse(lifecycleStage, query);
  }
}

// Умные ответы как fallback
function getSmartFallbackResponse(stage: string, userQuery: string) {
  const query = userQuery.toLowerCase();
  
  // Ответы для беременности
  if (stage === 'pregnancy') {
    if (query.includes('тошнот') || query.includes('токсикоз')) {
      return "Тошнота во время беременности - это нормальное явление. Попробуйте есть небольшими порциями, избегайте жирной пищи и пейте больше воды. Если тошнота сильная, обратитесь к врачу.";
    }
    if (query.includes('питани') || query.includes('еда')) {
      return "Во время беременности важно сбалансированное питание. Включите в рацион фолиевую кислоту, железо, кальций. Избегайте сырого мяса, рыбы с высоким содержанием ртути и непастеризованных продуктов.";
    }
    if (query.includes('сон') || query.includes('спать')) {
      return "Сон во время беременности может быть нарушен. Попробуйте спать на боку, используйте подушки для поддержки. Избегайте кофеина во второй половине дня.";
    }
    if (query.includes('боль') || query.includes('болит')) {
      return "Если у вас сильные боли, особенно внизу живота, немедленно обратитесь к врачу. Легкие тянущие ощущения могут быть нормальными, но лучше проконсультироваться со специалистом.";
    }
    return "Во время беременности важно регулярно посещать врача, следить за питанием и избегать стрессов. Каждый организм индивидуален, поэтому при любых сомнениях обращайтесь к специалистам.";
  }
  
  // Ответы для послеродового периода
  if (stage === 'postpartum') {
    if (query.includes('грудн') || query.includes('кормлени')) {
      return "Грудное вскармливание может быть сложным в первые дни. Обратитесь к консультанту по грудному вскармливанию, если возникают проблемы. Помните: важно ваше здоровье и комфорт.";
    }
    if (query.includes('депресси') || query.includes('грустн')) {
      return "Послеродовая депрессия - это серьезное состояние. Не стесняйтесь обращаться за помощью к психологу или психиатру. Вы не одиноки, и помощь доступна.";
    }
    if (query.includes('восстановлени') || query.includes('спорт')) {
      return "Восстановление после родов требует времени. Начните с легких упражнений только после разрешения врача. Не торопитесь - ваше тело прошло через многое.";
    }
    return "Послеродовой период - время восстановления. Не забывайте заботиться о себе, обращайтесь за помощью к близким и специалистам. Вы делаете отличную работу!";
  }
  
  // Ответы для ухода за ребенком
  if (stage === 'childcare') {
    if (query.includes('плач') || query.includes('кричит')) {
      return "Плач - это способ общения малыша. Проверьте: голоден ли, нужна ли смена подгузника, не жарко ли. Если плач не прекращается, обратитесь к педиатру.";
    }
    if (query.includes('сон') || query.includes('спать')) {
      return "Сон новорожденного нерегулярный. Создайте спокойную обстановку, следите за температурой в комнате. Помните: каждый ребенок индивидуален.";
    }
    if (query.includes('кормлени') || query.includes('еда')) {
      return "Кормление по требованию - лучший подход для новорожденных. Следите за признаками голода и сытости. При проблемах с кормлением обратитесь к педиатру.";
    }
    return "Уход за ребенком - это обучение. Не бойтесь задавать вопросы педиатру, обращайтесь за поддержкой к близким. Вы отличный родитель!";
  }
  
  return "Спасибо за ваш вопрос! Помните, что при любых сомнениях лучше обратиться к специалисту. Ваше здоровье и благополучие важны.";
}
